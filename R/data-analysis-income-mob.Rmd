---
title: "wealth-mobility"
author: "Abhraneel Sarma"
date: "8/3/2018"
output:
  html_document:
    df_print: kable
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

If you are missing any of the packages below, use `install.packages("packagename")` to install them.
The `import::` syntax requires the `import` package to be installed, and provides a simple way to 
import specific functions from a package without polluting your entire namespace (unlike `library()`)

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse)
library(magrittr)
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(brms)
library(modelr)
library(tidybayes)
library(ggstance)
```


## The Data
The de-identified data consists of the following variables: `parent's wealth quintile`, `child's wealth quintile`, `white (binary; whether the race of the person is white or not)` and `female (binary; whether the person's gender is female or not)`. We do not use female in the subsequent analysis.

```{r}
df <- read.csv("../data/Data.csv")

df %<>%
  na.omit() %>%
  select(id, white, female, pwealthqn, wealthqn) %>%
  rename(
    quantile = wealthqn,
    pquantile = pwealthqn
  ) %>%
  mutate(
    id = as.factor(id),
    white = as.factor(white),
    female = as.factor(female),
    pquantile = as.factor(pquantile)
  ) %>%
  as.data.frame(.)

head(df)
```


## Model
Here, we've used an adjacent category model `(family = "acat")` for the ordinal logistic regression. However, I do not have a strong basis for choosing this family, and a cumulative logit model or other families for ordinal regression can be used as well.

$$
\begin{align}
log(\frac{Pr(y_i = k)}{Pr(y_i = k+1)}) & = \alpha_k - \phi_i \\
\phi_i & = \beta_p P_i +  \beta_r[k] R_i\\
\beta_p, \beta_r &\sim \textrm{Normal}(0, 1) \\
\alpha_k & \sim \textrm{Normal}(0,1)
\end{align}
$$

```{r}
get_prior(quantile ~ pquantile + cs(white), data = df, family = "acat")
```

```{r}
# Load the model instead of running them
load("m1.cat-specific.RData")
#m1.acm = brm(quantile ~ pquantile + cs(white), data = df, family = "acat", prior=prior(normal(0, 1), class=b), iter = 5000, warmup = 2000, chains = 2)

summary(m1.acm)
```

```{r}
#This could not be uploaded to github because of size restrictions
#m1.acm1 = brm(quantile ~ pquantile + cs(white) + (1|id), data = df, family = "acat", prior=prior(normal(0, 1), class=b), iter = 5000, warmup = 2000, chains = 2)
summary(m1.acm1)
```


```{r}
df %>%
  data_grid(pquantile, white) %>%
  add_fitted_draws(m1.acm, re_formula = NA) %>%
  group_by(white, pquantile, .category) %>%
  mean_qi(.value)
```

```{r fig.height = 3, fig.width = 12}
df %>%
  data_grid(pquantile, white) %>%
  add_fitted_draws(m1.acm, re_formula = NA) %>%
  group_by(.category, pquantile, white) %>%
  ggplot(aes(y = .category, x = .value, color = white))+
  stat_pointintervalh(.width = 0.95, position = position_dodgev(height = 0.5), show.legend = TRUE) +
  facet_grid(.~pquantile)
```

```{r fig.height = 3, fig.width = 12}
df %>%
  data_grid(pquantile, white) %>%
  add_fitted_draws(m1.acm1, re_formula = NA) %>%
  group_by(.category, pquantile, white) %>%
  ggplot(aes(y = .category, x = .value, color = white))+
  stat_pointintervalh(.width = 0.95, position = position_dodgev(height = 0.5), show.legend = TRUE) +
  facet_grid(.~pquantile)
```


