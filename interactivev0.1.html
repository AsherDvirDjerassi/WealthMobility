<!DOCTYPE html>
<html>
<head>

	<!-- Bootstrap Core JS  -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

	<!-- Bootstrap Core CSS  -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,600,700,800,900" rel="stylesheet">

	<style>
		#graph {
			position: relative;
		}

		.black {
			font-weight: 600;
			color: white;
			background-color: rgba(74, 74, 74, 0.85);
			padding: 4px 8px;
			border-radius: : 4px;
		}

		.white {
			font-weight: 600;
			color: white;
			background-color: rgba(74, 186, 123, 0.85);
			padding: 4px 8px;
		}

		h3 {
			font-family: 'Raleway', sans-serif;
			font-weight: 500;
			font-size: 19px;
			line-height: 32px;
		}

		.drop-btn {
			width: 128px !important;
			display: inline-block;
			padding: 6px 12px !important;
			text-align: left;
			margin: 0px 8px;
		}
	</style>
</head>
<body>
	<div class="container">
		<!-- Interactive visualization -->
		<div class="row">
			<div class="col-md-12">
				<h3><span class="black" style="border-radius: 4px">Black</span> and <span class="white" style="border-radius: 4px">White</span> children raised in 
					<span>
						<div class="dropdown" style="display: inline-block;">
							<button class="btn btn-default dropdown-toggle drop-btn" type="button" data-toggle="dropdown">all
							<span class="caret"></span></button>
							<ul class="dropdown-menu dropdown-bar">
								<li><a onclick="draw_flow(div, 5)">top 20%</a></li>
								<li><a onclick="draw_flow(div, 4)">20% - 40%</a></li>
								<li><a onclick="draw_flow(div, 3)">40% - 60%</a></li>
								<li><a onclick="draw_flow(div, 2)">60% - 80%</a></li>
								<li><a onclick="draw_flow(div, 1)">bottom 20%</a></li>
								<li><a onclick="draw_flow(div)">all</a></li>
							</ul>
						</div>
					</span> of the households (by wealth).
				</h3>
				<div id='graph'></div>
			</div>
		</div>
	</div>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://npmcdn.com/regl/dist/regl.js"></script>

<script>
	$(function(){
		$(".dropdown-menu").on('click', 'li a', function(){
			$(".drop-btn:first-child").html($(this).text()+ ' <span class="caret"></span>');
		});
	})

	var canvas = { w: 960, h: 540 },
		margin = { left: 10, bottom: 10, right: 10, top: 10 };
		black_ratio_quintile = {
			"1": 0.769,
			"2": 0.485,
			"3": 0.255,
			"4": 0.011,
			"5": 0.047
		},
		wealth_scale = {
			// this is the wealth scale for whites
			"0": {
				"1": [0.34, 0.63, 0.803, 0.898],
				"2": [0.225, 0.489, 0.725, 0.877],
				"3": [0.17, 0.384, 0.632, 0.851],
				"4": [0.114, 0.266, 0.476, 0.757],
				"5": [0.067, 0.137, 0.272, 0.583]
			},
			// this is the wealth scale for blacks
			"1": {
				"1": [0.447, 0.75, 0.929, 0.983],
				"2": [0.398, 0.704, 0.948, 0.975],
				"3": [0.378, 0.652, 0.972, 0.999],
				"4": [0.365, 0.657, 0.657, 0.999],
				"5": [0.019, 0.035, 0.479, 0.999]
			}
		}

	var div = d3.select('#graph')
				.append('div')
				.style('position', 'relative')
				.style('left', '0px')
				.style('top', '0px')
				.style('width', canvas.w + 'px')
				.style('height', canvas.h + 'px');

	var count = 10000;

	var yScale = d3.scaleLinear()
		.domain([1, 5])
		.range([-0.8, 0.8])

	function draw_flow(element, parent = "all") {
		d3.select('canvas').remove();

		parent == "all" ? count = 10000 : count = 4000;
		console.log(count);

		var qScale = d3.scaleThreshold()
			.domain([0.331, 0.554, 0.721, 0.858])
			.range([1, 2, 3, 4, 5]);

		var wScale = d3.scaleThreshold()
		// 	.domain(white_threshold)
		 	.range([1, 2, 3, 4, 5]);

		var bScale = d3.scaleThreshold()
		// 	.domain(black_threshold)
		 	.range([1, 2, 3, 4, 5]);


		var data = d3.range(count).map(i => {
			if (parent == "all"){
				var p = Math.random();
				var p_quintile = qScale(p);
			} else {
				p_quintile = parent;
				count = 4000;
			}
			
			var isB = (Math.random() <= black_ratio_quintile[p_quintile]) ? 1 : 0;

			if (isB){
				var q = bScale.domain(wealth_scale[isB][p_quintile])( Math.random() );
			} else {
				var q = wScale.domain(wealth_scale[isB][p_quintile])( Math.random() );
			};

			return {
				speed: Math.random() * 2 + 1,
				x: Math.random() * 2 - 1,
				y0: yScale(p_quintile),
				y1: yScale(q),
				dy: (Math.random() - 0.5)* 0.25,
				isB
			}
		})

		data = d3.shuffle(data);
		
		var regl = createREGL({container: element.node()})

		var drawPoints = regl({
			vert: `
				precision mediump float;
				attribute float speed, x, y0, y1, dy;
				attribute float isB;
				varying float c;
				uniform float interp;			
				void main() {
					float t = mod(x + interp*speed, 1.0);
					
					// cubic ease
					float ct = t < 0.5
						? 32.0 * pow(t, 6.0)
						: -0.5 * pow(abs(2.0 * t - 2.0), 10.0) + 1.0;

					float x = mix(-1.0, 1.0, t);
					float y = mix(y0, y1, ct);

					gl_Position = vec4(x, y + dy, 0, 1);
					gl_PointSize = 8.0;

					c = isB;
				}`,

			frag: `
				precision mediump float;
				varying float c;
				void main() {
					vec4 blue = vec4(0.29, 0.73, 0.48, 0.85);
					vec4 orng = vec4(0.30, 0.30, 0.30, 0.85);

					gl_FragColor = c == 1.0 ? orng : blue;
				}`,

			attributes: {
				speed: data.map(d => d.speed),
				x:	data.map(d => d.x),
				y0: data.map(d => d.y0),
				y1: data.map(d => d.y1),
				dy: data.map(d => d.dy),
				isB: data.map(d => d.isB)
			},
			uniforms: {
				interp: function(context, props){
					return props.interp;
				}
			},
			primitive: 'point',
			count
		})

		regl.frame(({ time }) => {
			drawPoints({ 
				data: data,
				interp: time / 50 
			})
		})
	}

	draw_flow(div);
</script>
</html>